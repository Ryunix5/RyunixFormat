import{n as e,r as t,t as n}from"./index-D4-mxY65.js";var r=class r{static instance=null;static getInstance(){return r.instance||=new r,r.instance}parseStructured(t){if(!t||!t.structured)return{};let n={};for(let r of t.structured)if(r.name)switch(r.type){case e.string:case 0:n[r.name]=r.string??``;break;case e.number:case 1:n[r.name]=r.number??0;break;case e.boolean:case 2:n[r.name]=!!r.boolean;break;case e.enumeration:case 3:n[r.name]=r.enumeration??0;break;case e.array:case 4:n[r.name]=(r.array||[]).map(e=>this.parseStructured({structured:[e]}));break;case e.object:case e.reference:case 5:case 6:n[r.name]=this.parseStructured({structured:r.object||[]});break;default:n[r.name]=null}return n}rowToData(t){let n=[];for(let[r,i]of Object.entries(t||{})){let t=e.string;typeof i==`number`?t=e.number:typeof i==`boolean`?t=e.boolean:Array.isArray(i)?t=e.array:typeof i==`object`&&i&&(t=e.object);let a={type:t,name:r,string:typeof i==`string`?i:i==null?``:String(i),number:typeof i==`number`?i:void 0,boolean:typeof i==`boolean`?i:void 0,object:[],array:[]};n.push(a)}return{structured:n}}indexToFilter(e){if(!e)return{};if(!Array.isArray(e.fields)||!Array.isArray(e.values)){if(typeof e==`object`){let t={};for(let[n,r]of Object.entries(e))t[n]=r.value??r;return t}return{}}let t={};for(let n=0;n<(e.fields||[]).length;n++){let r=e.fields[n],i=e.values[n];if(r){if(!i){t[r]=null;continue}t[r]=i.string??i.number??i.boolean??i.enumeration??null}}return t}async all(e){let t=e.name,{data:r,error:i}=await n.from(t).select(`*`);if(i)throw i;return{data:{values:(r||[]).map(e=>this.rowToData(e))}}}async insert(e){let t=e.name,r=(e.batch||[]).map(e=>this.parseStructured(e));r=r.map(e=>{let t={};for(let[n,r]of Object.entries(e))if(!((r===``||r===null)&&[`id`,`data_creator`,`data_updater`,`create_time`,`update_time`].includes(n))){if(n===`coin`){if(r===``||r==null){t[n]=0;continue}let e=Number(r);t[n]=Number.isFinite(e)?e:0;continue}t[n]=r}return t}),console.debug(`Supabase insert rows:`,r);let{data:i,error:a}=await n.from(t).insert(r).select();if(a)throw a;return{data:{values:(i||[]).map(e=>this.rowToData(e))}}}async purge(e){let t=e.name,{error:r}=await n.from(t).delete().neq(`id`,``);if(r)throw r;return{}}async get(e){let t=e.name;if(e.ids&&e.ids.length>0){let{data:r,error:i}=await n.from(t).select(`*`).in(`id`,e.ids);if(i)throw i;return{data:{values:(r||[]).map(e=>this.rowToData(e))}}}if(e.index){let r=e.index,i=this.indexToFilter(r),a=n.from(t).select(`*`);for(let[e,t]of Object.entries(i))a=a.eq(e,t);let{data:o,error:s}=await a;if(s)throw s;return{data:{values:(o||[]).map(e=>this.rowToData(e))}}}return{data:{values:[]}}}async set(e){let t=e.name,r=this.parseStructured(e.data);if(e.index&&Object.keys(e.index).length>0){let i=this.indexToFilter(e.index),[a,o]=Object.entries(i)[0]||[],{data:s,error:c}=await n.from(t).update(r).eq(a,o).select();if(c)throw c;return{data:{values:(s||[]).map(e=>this.rowToData(e))}}}if(r.id){let e={};for(let[t,n]of Object.entries(r))(n===``||n===null)&&[`id`,`data_creator`,`data_updater`,`create_time`,`update_time`].includes(t)||(e[t]=n);let{data:i,error:a}=await n.from(t).upsert(e).select();if(a)throw a;return{data:{values:(i||[]).map(e=>this.rowToData(e))}}}throw Error(`Cannot determine primary key for set operation`)}async delete(e){let t=e.name;if(e.ids&&e.ids.length>0){let{error:r}=await n.from(t).delete().in(`id`,e.ids);if(r)throw r;return{}}if(e.index){let r=e.index,i=n.from(t).delete();for(let[e,t]of Object.entries(r))i=i.eq(e,t.value??t);let{error:a}=await i;if(a)throw a;return{}}throw Error(`Nothing to delete`)}async mGet(e){return this.get(e)}async mSet(e){let t=e.name,r=(e.data||[]).map(e=>this.parseStructured(e));r=r.map(e=>{let t={};for(let[n,r]of Object.entries(e))if(!((r===``||r===null)&&[`id`,`data_creator`,`data_updater`,`create_time`,`update_time`].includes(n))){if(n===`coin`){let e=typeof r==`string`?r===``?0:Number(r):r;t[n]=Number.isFinite(Number(e))?Number(e):0;continue}t[n]=r}return t});let{data:i,error:a}=await n.from(t).upsert(r).select();if(a)throw a;return{data:{values:(i||[]).map(e=>this.rowToData(e))}}}async list(e){let r=e.name,i=n.from(r).select(`*`);if(e.filter&&e.filter.simples&&e.filter.simples.length>0)for(let n of e.filter.simples)n.symbol===t.equal&&(i=i.eq(n.field,n.value)),n.symbol===t.in&&(i=i.in(n.field,n.value));if(e.paginate){let t=e.paginate.number||0,n=e.paginate.size||100;i=i.range(t*n,t*n+n-1)}let{data:a,error:o}=await i;if(o)throw o;return{data:{values:(a||[]).map(e=>this.rowToData(e)),page:{number:e.paginate?.number||0,size:e.paginate?.size||(a||[]).length}}}}async increaseCounter(e){let t=e.name;if(!e.index)throw Error(`increaseCounter requires an index`);let r=e.index,[i,a]=Object.entries(r)[0]||[],o=e.field||`count`,s=e.amount??e.delta??1,{data:c,error:l}=await n.from(t).update({[o]:s}).eq(i,a.value??a).select();if(l)throw l;return{data:{values:(c||[]).map(e=>this.rowToData(e))}}}async countRankedList(e){return{data:{values:[],page:{number:0,size:0}}}}};export{r as SupabaseDataStoreClient};